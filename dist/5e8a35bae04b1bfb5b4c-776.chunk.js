"use strict";exports.id=776,exports.ids=[776],exports.modules={1776:function(e,t,n){var i=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,i,o)}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&i(t,e,n);return o(t,e),t},s=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{d(i.next(e))}catch(e){r(e)}}function a(e){try{d(i.throw(e))}catch(e){r(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}d((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.check=t.clientGen=void 0;const d=n(8602),l=r(n(5104)),c=n(890),f=a(n(8461)),u=a(n(1017)),p=n(6750),h=a(n(9796)),m=a(n(3837)),y=n(1409),g=n(5110),v=m.default.promisify(h.default.inflate),w={};process.env.SC_DEVTOKEN&&(w["sc-devtoken"]=process.env.SC_DEVTOKEN);const _=l.default.create({baseURL:"https://api.strairecloud.com/",headers:w});_.interceptors.response.use(void 0,(function(e){if(!(0,l.isAxiosError)(e))throw e;const t=e.config;if(!t)throw e;if("_retries"in t&&"number"==typeof t._retries||(t._retries=0),t._retries>=3)throw e;return t._retries++,(0,l.default)(t)}));const b=new y.Logger("API.Manager"),j=p.z.object({name:p.z.string(),filter:d.specFilterValidator.optional()}),k=p.z.array(j),O="scapis";function E(e,t,n){return s(this,void 0,void 0,(function*(){const i=n?`?filter=${encodeURIComponent(JSON.stringify(n))}`:"",o=yield _.get(`/k8soperator/backends/${e}/client${i}`,{timeout:3e4});for(const n in o.data.files){const i=yield v(Buffer.from(o.data.files[n],"base64")),r=u.default.join(t,e,n);yield(0,c.mkdir)(u.default.dirname(r),{recursive:!0}),yield(0,c.writeFile)(r,i)}return o.data.specHash}))}t.clientGen=E,t.check=function(e){return s(this,void 0,void 0,(function*(){b.debug("Checking API status..."),e||(e=process.cwd()),yield function(e){var t;return s(this,void 0,void 0,(function*(){const n=u.default.join(e,"package.json");if(!(yield(0,y.fsExists)(n)))throw new Error("no package.json in working directory");if(!(yield(0,y.fsExists)(u.default.join(e,"node_modules"))))throw new Error("no node_modules folder");const i=JSON.parse(yield(0,c.readFile)(n,"utf-8"));if(!(null===(t=i.dependencies)||void 0===t?void 0:t.axios))throw new Error("axios is not dependency in package.json")}))}(e);const t=u.default.join(e,"node_modules","@strairecloud/api"),n=yield function(e){return s(this,void 0,void 0,(function*(){const t=yield(0,g.loadPackageJson)(e);return t[O]?k.parse(t[O]):[]}))}(e);let i=[];const o=u.default.join(t,"installed.json");try{const e=yield(0,c.readFile)(o,"utf-8");i=JSON.parse(e)}catch(e){if("ENOENT"!==e.code)throw e;b.debug("Installed file does not exist")}let r=!1;if(n.length){const e=yield _.get(`/k8soperator/backends?backends=${n.map((e=>e.name)).join("&backends=")}`,{timeout:5e3});if(!e.data.every((e=>e.shortName)))throw new Error("Invalid backend response "+JSON.stringify(e.data));b.debug("Handling new installations");for(const o of n){const n=e.data.find((e=>e.shortName===o.name)),s=i.find((e=>e.name===o.name));if(!n)throw new Error(`Could not find api ${o.name}`);const a=o.filter?(0,f.default)(o.filter,{unorderedArrays:!0}):void 0,d=yield(0,y.fsExists)(u.default.join(t,o.name));if(n.specHash===(null==s?void 0:s.hash)&&a===(null==s?void 0:s.filterHash)&&d)continue;r||(r=!0),b.debug(`Updating api client for ${o.name}`);const l=yield E(o.name,t,o.filter);if(l!==n.specHash)throw new Error(`Race condition. Clientgen files: ${l}, api response: ${n.specHash}`);s?(s.hash=n.specHash,s.filterHash=a):i.push({name:o.name,hash:n.specHash,filterHash:a})}}else b.warn("Skipping install step");b.debug("Handling deletions");let a=[];for(const e of i)n.some((t=>t.name===e.name))?a.push(e):(yield(0,c.remove)(u.default.join(t,e.name)),b.warn(`Deleted ${e.name} from file system`),r||(r=!0));a=a.sort(((e,t)=>e.name<t.name?-1:e.name>t.name?1:0)),yield(0,c.writeFile)(o,JSON.stringify(a,null,4)),r||b.debug("No changes made")}))}}};
//# sourceMappingURL=5e8a35bae04b1bfb5b4c-776.chunk.js.map